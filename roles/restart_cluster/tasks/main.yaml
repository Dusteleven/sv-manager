---

- name: stop solana validator service
  systemd:
    name: solana-validator
    state: stopped
  tags:
    - validator.cluster.restart
    - validator.cluster.restart.stop

- name: "install solana {{ solana_version }}"
  shell: solana-install init {{ solana_version }}
  environment:
    PATH: "{{ env_path }}"
  become: yes
  become_user: "{{ solana_user }}"
  tags:
    - validator.cluster.restart
    - validator.cluster.restart.cli.install

- name: "Get ledger slot"
  become: yes
  become_user: "{{ solana_user }}"
  shell: "solana-ledger-tool -l {{ ledger_path }} latest-optimistic-slots | awk 'FNR==2{print $1}"
  register: __solana_ledger_slot
  environment:
    #PATH: "{{ node.solana_home }}/.local/share/solana/install/active_release/bin"
    PATH: "{{ env_path }}:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin"
    HOME: "{{ solana_home }}"
  tags:
    - validator.cluster.restart
    - validator.cluster.restart.ledger.slot

- name: create snapshot from ledger
  become: yes
  become_user: "{{ solana_user }}"
  shell: "solana-ledger-tool --ledger {{ ledger_path }} create-snapshot {{ __solana_ledger_slot.stdout }} {{ snapshots_path }}  --snapshot-archive-path {{ snapshots_path }} --hard-fork {{ __solana_ledger_slot.stdout }} --wal-recovery-mode skip_any_corrupted_record"
  environment:
    #PATH: "{{ node.solana_home }}/.local/share/solana/install/active_release/bin"
    PATH: "{{ env_path }}:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin"
    HOME: "{{ solana_home }}"
  tags:
    - validator.cluster.restart
    - validator.cluster.restart.ledger.snapshot

- name: Add --wait-for-supermajority for service
  lineinfile:
    path: /etc/default/solana-validator
    insertafter: '--no-untrusted-rpc \'
    line: "--wait-for-supermajority {{ __solana_ledger_slot.stdout }} \\"

#- name: Create solana validator service
#  template:
#    src: solana-validator.{{ cluster_environment }}.restart.service.j2
#    dest: /etc/systemd/system/solana-validator.service
#    backup: true
#    mode: 0644
#    owner: root
#    group: root
#  tags:
#    - validator.cluster.restart
#    - validator.cluster.restart.service

- name: start solana validator service
  systemd:
    name: solana-validator
    state: restart
    daemon_reload: yes
  tags:
    - validator.cluster.restart
    - validator.cluster.restart.start

- name: Remove --wait-for-supermajority for service
  lineinfile:
    path: /etc/default/solana-validator
    search_string: '--wait-for-supermajority'
    line: ''
